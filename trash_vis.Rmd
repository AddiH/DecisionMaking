```{r}

```{r}
# Prepare the data for plotting
plot_data <- lapply(names(data_list), function(study_name) {
  mu_w_samples <- data_list[[study_name]]$BUGSoutput$sims.list$mu_w
  data.frame(mu_w = mu_w_samples, Study = study_name)
}) %>% bind_rows()

# Calculate 95% CI for each study
ci_95 <- plot_data %>% group_by(Study) %>%
  summarise(Lower = quantile(mu_w, probs = 0.025),
            Upper = quantile(mu_w, probs = 0.975))

# Plotting
ggplot(plot_data, aes(x = mu_w, fill = Study)) +
  geom_density(alpha = 0.5) +
  geom_vline(data = ci_95, aes(xintercept = Lower, color = Study), linetype = "dashed") +
  geom_vline(data = ci_95, aes(xintercept = Upper, color = Study), linetype = "dashed") +
  labs(title = "Posterior Distributions of mu_w across Studies with 95% Credible Intervals",
       x = "mu_w values",
       y = "Density") +
  scale_fill_discrete(name = "Study") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
# Prepare the data for plotting
plot_data <- lapply(names(data_list), function(study_name) {
  mu_w_samples <- data_list[[study_name]]$BUGSoutput$sims.list$mu_w
  data.frame(mu_w = mu_w_samples, Study = study_name)
}) %>% bind_rows()

# Calculate the global minimum of the max values and global maximum of the min values across all studies
min_of_maxes <- plot_data %>% group_by(Study) %>% summarise(Max = max(mu_w)) %>% summarise(GlobalMin = min(Max))
max_of_mins <- plot_data %>% group_by(Study) %>% summarise(Min = min(mu_w)) %>% summarise(GlobalMax = max(Min))

# Plotting without the dashed lines
ggplot(plot_data, aes(x = mu_w, fill = Study)) +
  geom_boxplot(alpha = 0.5) +
  labs(title = "Filtered (95%) Posterior Distributions of mu_w across Studies",
       x = "mu_w values",
       y = "-") +
    geom_vline(xintercept = as.numeric(min_of_maxes$GlobalMin), color = "black", linetype = "dashed", size = .5) +
  geom_vline(xintercept = as.numeric(max_of_mins$GlobalMax), color = "black", linetype = "dashed", size = .5) +
  scale_fill_discrete(name = "Study") +
  theme_minimal() +
  theme(legend.position = "bottom", axis.text.y=element_blank())
```
```{r}
# Prepare the data for plotting
plot_data <- lapply(names(data_list), function(study_name) {
  mu_a_samples <- data_list[[study_name]]$BUGSoutput$sims.list$mu_a
  data.frame(mu_a = mu_a_samples, Study = study_name)
}) %>% bind_rows()

# Calculate the global minimum of the max values and global maximum of the min values across all studies
min_of_maxes <- plot_data %>% group_by(Study) %>% summarise(Max = max(mu_a)) %>% summarise(GlobalMin = min(Max))
max_of_mins <- plot_data %>% group_by(Study) %>% summarise(Min = min(mu_a)) %>% summarise(GlobalMax = max(Min))

# Plotting without the dashed lines
ggplot(plot_data, aes(x = mu_a, fill = Study)) +
  geom_boxplot(alpha = 0.5) +
  labs(title = "Filtered (95%) Posterior Distributions of mu_a across Studies",
       x = "mu_a values",
       y = "-") +
    geom_vline(xintercept = as.numeric(min_of_maxes$GlobalMin), color = "black", linetype = "dashed", size = .5) +
  geom_vline(xintercept = as.numeric(max_of_mins$GlobalMax), color = "black", linetype = "dashed", size = .5) +
  scale_fill_discrete(name = "Study") +
  theme_minimal() +
  theme(legend.position = "bottom", axis.text.y=element_blank())
```

```{r}
# Prepare the data for plotting
plot_data <- lapply(names(data_list), function(study_name) {
  mu_A_samples <- data_list[[study_name]]$BUGSoutput$sims.list$mu_A
  data.frame(mu_A = mu_A_samples, Study = study_name)
}) %>% bind_rows()

# Calculate the global minimum of the max values and global maximum of the min values across all studies
min_of_maxes <- plot_data %>% group_by(Study) %>% summarise(Max = max(mu_A)) %>% summarise(GlobalMin = min(Max))
max_of_mins <- plot_data %>% group_by(Study) %>% summarise(Min = min(mu_A)) %>% summarise(GlobalMax = max(Min))

# Plotting without the dashed lines
ggplot(plot_data, aes(x = mu_A, fill = Study)) +
  geom_boxplot(alpha = 0.5) +
  labs(title = "Filtered (95%) Posterior Distributions of mu_A across Studies",
       x = "mu_A values",
       y = "-") +
    geom_vline(xintercept = as.numeric(min_of_maxes$GlobalMin), color = "black", linetype = "dashed", size = .5) +
  geom_vline(xintercept = as.numeric(max_of_mins$GlobalMax), color = "black", linetype = "dashed", size = .5) +
  scale_fill_discrete(name = "Study") +
  theme_minimal() +
  theme(legend.position = "bottom", axis.text.y=element_blank())
```

```{r}
# Prepare the data for plotting
plot_data <- lapply(names(data_list), function(study_name) {
  mu_theta_samples <- data_list[[study_name]]$BUGSoutput$sims.list$mu_theta
  data.frame(mu_theta = mu_theta_samples, Study = study_name)
}) %>% bind_rows()

# Calculate the global minimum of the max values and global maximum of the min values across all studies
min_of_maxes <- plot_data %>% group_by(Study) %>% summarise(Max = max(mu_theta)) %>% summarise(GlobalMin = min(Max))
max_of_mins <- plot_data %>% group_by(Study) %>% summarise(Min = min(mu_theta)) %>% summarise(GlobalMax = max(Min))

# Plotting without the dashed lines
ggplot(plot_data, aes(x = mu_theta, fill = Study)) +
  geom_boxplot(alpha = 0.5) +
  labs(title = "Filtered (95%) Posterior Distributions of mu_theta across Studies",
       x = "mu_theta values",
       y = "-") +
    geom_vline(xintercept = as.numeric(min_of_maxes$GlobalMin), color = "black", linetype = "dashed", size = .5) +
  geom_vline(xintercept = as.numeric(max_of_mins$GlobalMax), color = "black", linetype = "dashed", size = .5) +
  scale_fill_discrete(name = "Study") +
  theme_minimal() +
  theme(legend.position = "bottom", axis.text.y=element_blank())
```

```{r}
# First, calculate the 95% CI for each study
ci_95 <- plot_data %>% group_by(Study) %>%
  summarise(Lower = quantile(mu_w, probs = 0.025),
            Upper = quantile(mu_w, probs = 0.975))

# Join the CI bounds back to the plot_data
plot_data_filtered <- plot_data %>%
  left_join(ci_95, by = "Study")

# Filter out values outside the 95% credible intervals
plot_data_filtered <- plot_data_filtered %>%
  filter(mu_w >= Lower, mu_w <= Upper)

# Calculate the global minimum of the max values and global maximum of the min values across all studies
min_of_maxes <- plot_data %>% group_by(Study) %>% summarise(Max = max(mu_w)) %>% summarise(GlobalMin = min(Max))
max_of_mins <- plot_data %>% group_by(Study) %>% summarise(Min = min(mu_w)) %>% summarise(GlobalMax = max(Min))

# Plotting without the dashed lines
ggplot(plot_data_filtered, aes(x = mu_w, fill = Study)) +
  geom_boxplot(alpha = 0.5) +
  labs(title = "Filtered (95%) Posterior Distributions of mu_w across Studies",
       x = "mu_w values",
       y = "-") +
    geom_vline(xintercept = as.numeric(min_of_maxes$GlobalMin), color = "black", linetype = "dashed", size = .5) +
  geom_vline(xintercept = as.numeric(max_of_mins$GlobalMax), color = "black", linetype = "dashed", size = .5) +
  scale_fill_discrete(name = "Study") +
  theme_minimal() +
  theme(legend.position = "bottom", axis.text.y=element_blank())
```
study_info <- data.frame(
  Study = names(data_list), 
  NumSubjects = c(162, 19, 40, 70, 25, 153, 35, 15, 57, 41) 
)

```{r}
study_info <- data.frame(
  Study = names(data_list), 
  NumSubjects = c(162, 19, 40, 70, 25, 153, 35, 15, 57, 41) 
)

x_lim <- max(plot_data_filtered$mu_w) * 1.0

plot <- ggplot(plot_data_filtered, aes(x = mu_w, fill = Study)) +
  geom_boxplot(alpha = 0.5) +
  labs(title = "Filtered (95%) Posterior Distributions of mu_w across Studies",
       x = "mu_w values") +
    geom_vline(xintercept = as.numeric(min_of_maxes$GlobalMin), color = "black", linetype = "dashed", size = .5) +
  geom_vline(xintercept = as.numeric(max_of_mins$GlobalMax), color = "black", linetype = "dashed", size = .5) +
  scale_fill_discrete(name = "Study") +
  theme_minimal() +
  theme(legend.position = "bottom") 


# Loop through the study_info to add annotations
for(i in 1:nrow(study_info)) {
  plot <- plot + annotate("text", x = -.2, y = i/10-.45, label = paste(study_info$Study[i], ":", study_info$NumSubjects[i]), hjust = 0, vjust = 0, size = 3)
}

# Adjust plot limits to make space for text annotations
plot + xlim(c(NA, x_lim))
```



```{r}
# Calculate the global minimum of the max values and global maximum of the min values across all studies
min_of_maxes <- plot_data %>% group_by(Study) %>% summarise(Max = max(mu_w)) %>% summarise(GlobalMin = min(Max))
max_of_mins <- plot_data %>% group_by(Study) %>% summarise(Min = min(mu_w)) %>% summarise(GlobalMax = max(Min))

# Now plot the boxplot with vertical lines indicating the overlap region
ggplot(plot_data, aes(x = Study, y = mu_w)) +
  geom_boxplot() +
  geom_vline(xintercept = as.numeric(min_of_maxes$GlobalMin), color = "blue", linetype = "dashed", size = 1) +
  geom_vline(xintercept = as.numeric(max_of_mins$GlobalMax), color = "blue", linetype = "dashed", size = 1) +
  labs(title = "Boxplot of mu_w across Studies with Overlap Region",
       x = "Study",
       y = "mu_w") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) # Adjust x-axis labels for better readability
```



```{r}
# Prepare the data for plotting
plot_data <- lapply(names(data_list), function(study_name) {
  mu_w_samples <- data_list[[study_name]] # Replace with actual extraction
  data.frame(mu_w = mu_w_samples, Study = study_name)
}) %>% bind_rows()

# Calculate 95% CI for each study
ci_95 <- plot_data %>% group_by(Study) %>%
  summarise(Lower = quantile(mu_w, probs = 0.025),
            Upper = quantile(mu_w, probs = 0.975))

# Plotting
ggplot(plot_data, aes(x = mu_w, fill = Study)) +
  geom_density(alpha = 0.5) +
  geom_vline(data = ci_95, aes(xintercept = Lower, color = Study), linetype = "dashed") +
  geom_vline(data = ci_95, aes(xintercept = Upper, color = Study), linetype = "dashed") +
  labs(title = "Posterior Distributions of mu_w across Studies with 95% Credible Intervals",
       x = "mu_w values",
       y = "Density") +
  scale_fill_discrete(name = "Study") +
  theme_minimal() +
  theme(legend.position = "bottom")
```




```{r}
# let's look at the posteriors for the parameters
#par(mfrow=c(2,2))
plot(density(samples$BUGSoutput$sims.list$mu_w))
```


```{r}
plot(density(samples$BUGSoutput$sims.list$mu_A))
plot(density(samples$BUGSoutput$sims.list$mu_theta))
plot(density(samples$BUGSoutput$sims.list$mu_a))

# let's look at the posteriors for the parameters
par(mfrow=c(2,2))
plot(density(samples$BUGSoutput$sims.list$lambda_w))
plot(density(samples$BUGSoutput$sims.list$lambda_A))
plot(density(samples$BUGSoutput$sims.list$lambda_theta))
plot(density(samples$BUGSoutput$sims.list$lambda_a))
```


```{r}
# Get w
mu_w_samples <- Fridberg$BUGSoutput$sims.list$mu_w

# Calculate the 95% credible interval
ci_95 <- quantile(mu_w_samples, probs = c(0.025, 0.975))

# Create a data frame for plotting
df <- data.frame(mu_w = mu_w_samples)

# Plot
ggplot(df, aes(x = mu_w)) +
  geom_density(fill = "skyblue", alpha = 0.7) +
  geom_vline(xintercept = ci_95[1], col = "red", linetype = "dashed") +
  geom_vline(xintercept = ci_95[2], col = "red", linetype = "dashed") +
  labs(title = "Posterior Distribution of mu_w with 95% Credible Interval",
       x = "mu_w values",
       y = "Density") +
  theme_minimal()

```



```{r}

```{r}
generate_parameter_plot <- function(parameter_name) {
  plot_data <- lapply(study_info$Study, function(study_name) {
    parameter_samples <- data_list[[study_name]]$BUGSoutput$sims.list[[parameter_name]]
    num_trials <- study_info$NumTrials[study_info$Study == study_name] # Get the number of trials for the study
    data.frame(Parameter = parameter_samples, Study = study_name, 
               NumSubjects = study_info$NumSubjects[study_info$Study == study_name],
               NumTrials = num_trials) # Add NumTrials to the data frame
  }) %>% bind_rows() %>%
    arrange(desc(NumSubjects)) %>%
    mutate(Study = factor(Study, levels = study_info$Study))

  plot_data$NumTrials <- factor(plot_data$NumTrials)

  # Calculate 95% CI for each study
  ci_95 <- plot_data %>% group_by(Study) %>%
    summarise(Lower = quantile(Parameter, probs = 0.025),
              Upper = quantile(Parameter, probs = 0.975))

  min_of_maxes <- plot_data %>% group_by(Study) %>% summarise(Max = max(Parameter)) %>% summarise(GlobalMin = min(Max))
  max_of_mins <- plot_data %>% group_by(Study) %>% summarise(Min = min(Parameter)) %>% summarise(GlobalMax = max(Min))

  # Plotting
  parameter_plot <- ggplot(plot_data, aes(x = Parameter, y = NumSubjects, color = NumTrials, fill = Study)) +
    geom_boxplot(alpha = 0.5, width = 2) +
    labs(title = paste("Filtered (95%) Posterior Distributions of", parameter_name, "across Studies"),
         x = paste(parameter_name, "values"),
         y = "Number of participants in study") +
      geom_vline(xintercept = as.numeric(min_of_maxes$GlobalMin), color = "black", linetype = "dashed", size = .5) +
    geom_vline(xintercept = as.numeric(max_of_mins$GlobalMax), color = "black", linetype = "dashed", size = .5) +
    scale_fill_discrete(name = "Study") +
    theme_minimal() +
    theme(legend.position = "bottom")

  ggsave(paste(parameter_name, ".png", sep = ""), parameter_plot, width = 30, height = 30, units = "cm")

  return(parameter_plot)
}
```
```

```
```{r}

```{r}
# Initialize an empty dataframe to store results
healthy_df <- data.frame()

# Iterate over each study in data_list
for(study_name in names(data_list)) {
  df <- data_list[[study_name]]
  subIDs <- unique(df$Subj)
  n_subs <- length(subIDs)
  n_trials <- length(df$Subj)/n_subs
  
  count <- df %>%
    mutate(trial_nr = rep(seq(0:(n_trials-1)),n_subs)) %>%
    mutate(x = case_when(
      x == 1 ~ "A", x == 2 ~ "B", x == 3 ~ "C", x == 4 ~ "D")) %>%
    filter(trial_nr >= n_trials - 50) %>%
    mutate(deck_group = case_when(
      x %in% c("A", "B") ~ "A+B", x %in% c("C", "D") ~ "C+D")) %>%
    group_by(Subj, deck_group) %>%
    summarise(count = n(), .groups = 'drop') %>%
    filter(deck_group == "A+B") %>%
    filter(count < 10) %>% 
    mutate(Study = study_name,
           NumOfTrials = n_trials,
           NumSubs = n_subs)
  
  no_of_healthy <- length(count$Subj)
  
  # Append to results_df
  healthy_df <- rbind(healthy_df, count)
}

health_status_df
```


```{r}

# Define a function to determine health status
is_healthy <- function(choices) {
  # Example criterion: fewer than 10 choices from A+B in the last 50 trials
  sum(choices >= n_trials - 50 & choices %in% c("A", "B")) < 10
}

healthy_df <- data.frame()

for(study_name in names(data_list)) {
  df <- data_list[[study_name]]

# Determine health status for each subject
health_status_df$Healthy <- sapply(health_status_df$Subj, function(subj_id) {
  subj_choices <- df$x[df$Subj == subj_id]
  is_healthy(subj_choices)
})

df <- df %>% mutate(health = health_status_df$Healthy)

# Append to results_df
  healthy_df <- rbind(healthy_df, health_status_df)
}
# Now health_status_df contains each subject's ID and their health status

```

```{r}
ggplot(healthy_df) +
  geom_bar(aes(x = Study, fill = ) )
```

```

